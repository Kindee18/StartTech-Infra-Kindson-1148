name: Backend CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "backend/**"
      - "scripts/**"
      - "appspec.yml"
      - ".github/workflows/backend-ci-cd.yml"
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  GO_VERSION: "1.25.1"

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Check code formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code formatting issues found:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Security scan with gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt=json -out=gosec-report.json -fmt=text ./... || true
          echo "=== Gosec Report ==="
          cat gosec-report.json | jq -r '.Stats // empty' || echo "No stats available"
          cat gosec-report.json | jq -r '.Issues[]? | "\(.severity): \(.rule_id) - \(.details) in \(.file):\(.line)"' || echo "No issues found or JSON parse error"
          # Fail only on HIGH or CRITICAL severity issues
          HIGH_CRITICAL_COUNT=$(cat gosec-report.json | jq '[.Issues[]? | select(.severity == "HIGH" or .severity == "CRITICAL")] | length' || echo "0")
          if [ "$HIGH_CRITICAL_COUNT" -gt 0 ]; then
            echo "Found $HIGH_CRITICAL_COUNT HIGH/CRITICAL security issues. Failing build."
            exit 1
          else
            echo "No HIGH/CRITICAL security issues found."
          fi
        continue-on-error: false

  build-and-deploy:
    name: Build & Deploy
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set environment variables
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "CODEDEPLOY_GROUP=${{ secrets.CODEDEPLOY_GROUP_PROD }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "CODEDEPLOY_GROUP=${{ secrets.CODEDEPLOY_GROUP_STAGING }}" >> $GITHUB_ENV
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        working-directory: backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_BACKEND }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.ENVIRONMENT }}

      - name: Scan Docker image for vulnerabilities
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_BACKEND }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image --severity HIGH,CRITICAL --exit-code 1 \
            $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_BACKEND }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.ENVIRONMENT }}

      - name: Deploy to ASG (Instance Refresh)
        run: |
          ASG_NAME="${ENVIRONMENT}-backend-asg"
          echo "Triggering instance refresh for ${ASG_NAME}..."
          
          # Trigger instance refresh
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG_NAME" \
            --preferences '{"MinHealthyPercentage": 50, "InstanceWarmup": 60}' \
            --query 'InstanceRefreshId' \
            --output text)
          
          echo "Instance Refresh ID: ${REFRESH_ID}"
          
          # Wait for completion (with timeout)
          echo "Waiting for instance refresh to complete..."
          STATUS="InProgress"
          while [[ "$STATUS" == "InProgress" || "$STATUS" == "Pending" ]]; do
            sleep 30
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "$ASG_NAME" \
              --instance-refresh-ids "$REFRESH_ID" \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
            echo "Current Status: ${STATUS}"
          done
          
          if [[ "$STATUS" != "Successful" ]]; then
            echo "❌ Instance refresh failed with status: ${STATUS}"
            exit 1
          fi
          echo "✅ Instance refresh completed successfully!"

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against ${{ env.ENVIRONMENT }}..."
          MAX_RETRIES=5
          RETRY_COUNT=0

          if [ "${{ env.ENVIRONMENT }}" == "production" ]; then
            HEALTH_URL="${{ secrets.API_BASE_URL_PROD }}/health"
          else
            HEALTH_URL="${{ secrets.API_BASE_URL_STAGING }}/health"
          fi

          until [ $RETRY_COUNT -ge $MAX_RETRIES ]
          do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
            if [ $HTTP_CODE -eq 200 ]; then
              echo "✅ Health check passed!"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "Health check failed (attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in 10s..."
            sleep 10
          done

          echo "❌ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Deployment notification
        if: success()
        run: |
          echo "✅ Backend deployed successfully to ${{ env.ENVIRONMENT }}"
          echo "Image: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ github.sha }}"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "❌ Backend deployment failed for ${{ env.ENVIRONMENT }}"
          exit 1
